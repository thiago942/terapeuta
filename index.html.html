<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Travas Mentais</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        primary: '#5D5CDE',
                    }
                }
            }
        }
    </script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        .scale-card {
            transition: transform 0.2s;
        }
        .scale-card:hover {
            transform: translateY(-4px);
        }
        @media print {
            header, button:not(.no-print), .no-print {
                display: none !important;
            }
            body {
                background: white !important;
                color: black !important;
            }
            .print-content {
                display: block !important;
            }
        }
    </style>
</head>
<body class="bg-white dark:bg-[#181818] text-gray-900 dark:text-gray-100 transition-colors">

    <!-- Header -->
    <header class="bg-primary text-white shadow-lg sticky top-0 z-40">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-xl md:text-2xl font-bold cursor-pointer" onclick="navigateTo('home')">üß† Dashboard de Travas Mentais</h1>
            <div class="flex gap-2 md:gap-4">
                <button onclick="showPatientRegistrationForm()" class="px-3 py-2 text-sm md:text-base bg-white/20 hover:bg-white/30 rounded-lg transition">
                    ‚ûï Cadastrar
                </button>
                <button onclick="navigateTo('patients')" class="px-3 py-2 text-sm md:text-base bg-white/20 hover:bg-white/30 rounded-lg transition">
                    üë• Pacientes
                </button>
                <button onclick="navigateTo('analytics')" class="px-3 py-2 text-sm md:text-base bg-white/20 hover:bg-white/30 rounded-lg transition">
                    üìä Analytics
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main id="app" class="container mx-auto px-4 py-8">
        <!-- Content will be injected here -->
    </main>

    <!-- Modal Container -->
    <div id="modalContainer"></div>

    <script>
        // Dark mode setup
        if (window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches) {
            document.documentElement.classList.add('dark');
        }
        window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
            if (event.matches) {
                document.documentElement.classList.add('dark');
            } else {
                document.documentElement.classList.remove('dark');
            }
        });

        // Data structure for mental blocks
        const mentalBlocks = {
            autoconfianca: {
                name: 'Autoconfian√ßa',
                icon: 'üí™',
                color: 'bg-blue-500',
                pdfUrl: 'https://pfst.cf2.poecdn.net/base/application/b4f692792130a7c87ec581465dd5da295a3a4bfadd113d6ec7c24c3993c93eb8',
                symptoms: [
                    'D√∫vida constante sobre suas capacidades',
                    'Compara√ß√£o excessiva com os outros',
                    'Medo de fracasso ou rejei√ß√£o',
                    'Dificuldade em reconhecer conquistas',
                    'Inseguran√ßa em tomar decis√µes'
                ],
                techniques: [
                    'Registro de sucessos di√°rios',
                    'T√©cnica da cadeira vazia (Gestalt)',
                    'Afirma√ß√µes positivas baseadas em evid√™ncias',
                    'Desafio de cren√ßas limitantes',
                    'Exposi√ß√£o gradual a situa√ß√µes desafiadoras'
                ],
                protocols: {
                    'Destrave Amor Pr√≥prio': 'Trabalhar autocompaix√£o e aceita√ß√£o',
                    'Destrave Relacionamentos': 'Fortalecer assertividade e limites'
                },
                adultQuestions: [
                    'Eu me sinto capaz de enfrentar novos desafios',
                    'Confio nas minhas decis√µes',
                    'Reconhe√ßo minhas qualidades e conquistas',
                    'Me sinto seguro(a) ao expressar minhas opini√µes',
                    'Acredito que posso aprender e crescer'
                ],
                childQuestions: [
                    'Eu acho que consigo fazer coisas novas',
                    'Eu gosto de tentar coisas diferentes',
                    'Eu me sinto bem comigo mesmo(a)',
                    'Eu acho que sou bom(a) em algumas coisas',
                    'Eu n√£o tenho medo de errar'
                ]
            },
            escassez: {
                name: 'Escassez',
                icon: 'üí∞',
                color: 'bg-green-500',
                pdfUrl: 'https://pfst.cf2.poecdn.net/base/application/e9a99752937f91a57034e59db499faf6574406ba26dad911cba8611b6c1a2905',
                symptoms: [
                    'Medo constante de falta de recursos',
                    'Dificuldade em gastar mesmo tendo dinheiro',
                    'Sensa√ß√£o de "nunca √© suficiente"',
                    'Acumula√ß√£o excessiva de objetos',
                    'Ansiedade financeira desproporcional'
                ],
                techniques: [
                    'Reestrutura√ß√£o cognitiva sobre abund√¢ncia',
                    'Exerc√≠cios de gratid√£o',
                    'Planejamento financeiro consciente',
                    'T√©cnica do "suficiente"',
                    'Trabalho com cren√ßas de origem familiar'
                ],
                protocols: {
                    'Destrave Pais': 'Ressignificar mensagens sobre dinheiro',
                    'Destrave Amor Pr√≥prio': 'Reconhecer valor pessoal al√©m de bens'
                },
                adultQuestions: [
                    'Sinto que tenho recursos suficientes para viver bem',
                    'Consigo compartilhar sem medo de faltar',
                    'N√£o me comparo excessivamente com quem tem mais',
                    'Celebro minhas conquistas financeiras',
                    'Confio que vou conseguir o que preciso'
                ],
                childQuestions: [
                    'Eu divido minhas coisas com outras crian√ßas',
                    'Eu acho que tenho brinquedos suficientes',
                    'N√£o fico triste quando vejo outras crian√ßas com coisas legais',
                    'Eu sei que minha fam√≠lia cuida de mim',
                    'Eu n√£o guardo tudo s√≥ para mim'
                ]
            },
            aprovacao: {
                name: 'Aprova√ß√£o',
                icon: 'üëç',
                color: 'bg-pink-500',
                pdfUrl: 'https://pfst.cf2.poecdn.net/base/application/249df57131114d4eff3fae6b6280e41ea1c20110291447ddf43613468caad7d2',
                symptoms: [
                    'Necessidade excessiva de valida√ß√£o externa',
                    'Dificuldade em dizer "n√£o"',
                    'Mudan√ßa de comportamento conforme o p√∫blico',
                    'Medo de decepcionar os outros',
                    'Desconforto com cr√≠ticas construtivas'
                ],
                techniques: [
                    'Valida√ß√£o interna vs externa',
                    'Treino assertivo',
                    'Exerc√≠cios de autenticidade',
                    'Trabalho com crian√ßa interior',
                    'Estabelecimento de limites saud√°veis'
                ],
                protocols: {
                    'Destrave Relacionamentos': 'Desenvolver relacionamentos aut√™nticos',
                    'Destrave Amor Pr√≥prio': 'Autoaprova√ß√£o e autovalida√ß√£o'
                },
                adultQuestions: [
                    'Eu me sinto bem mesmo quando algu√©m discorda de mim',
                    'Consigo dizer n√£o quando necess√°rio',
                    'N√£o mudo minhas opini√µes para agradar',
                    'Me sinto confort√°vel sendo aut√™ntico(a)',
                    'Aceito cr√≠ticas sem me sentir rejeitado(a)'
                ],
                childQuestions: [
                    'Eu brinco do que eu gosto, mesmo que outros n√£o gostem',
                    'Eu consigo dizer n√£o para meus amigos',
                    'Eu n√£o mudo de ideia s√≥ para os outros gostarem de mim',
                    'Eu me sinto bem sendo eu mesmo(a)',
                    'N√£o fico muito triste quando algu√©m n√£o gosta do que eu fa√ßo'
                ]
            },
            perfeicao: {
                name: 'Perfei√ß√£o',
                icon: '‚ú®',
                color: 'bg-purple-500',
                pdfUrl: 'https://pfst.cf2.poecdn.net/base/application/72a319c13d13885f70a1355cb2b8339e9dbc4ac86741fdd22bb1cb4c2b09b2c9',
                symptoms: [
                    'Padr√µes irrealisticamente altos',
                    'Procrastina√ß√£o por medo de imperfei√ß√£o',
                    'Autocr√≠tica severa',
                    'Dificuldade em delegar tarefas',
                    'Insatisfa√ß√£o cr√¥nica com resultados'
                ],
                techniques: [
                    'Aceita√ß√£o de "suficientemente bom"',
                    'Exposi√ß√£o a imperfei√ß√µes controladas',
                    'Reestrutura√ß√£o de pensamentos autocr√≠ticos',
                    'Mindfulness e autocompaix√£o',
                    'Celebra√ß√£o de progresso vs perfei√ß√£o'
                ],
                protocols: {
                    'Destrave Amor Pr√≥prio': 'Aceita√ß√£o de imperfei√ß√µes',
                    'Destrave Pais': 'Desconstruir padr√µes impostos'
                },
                adultQuestions: [
                    'Aceito que "suficientemente bom" √© aceit√°vel',
                    'N√£o me paraliso por medo de errar',
                    'Sou gentil comigo quando cometo erros',
                    'Consigo delegar sem precisar controlar tudo',
                    'Celebro progressos mesmo que imperfeitos'
                ],
                childQuestions: [
                    'Eu entrego meus trabalhos mesmo que n√£o estejam perfeitos',
                    'N√£o apago e refa√ßo muitas vezes',
                    'N√£o fico muito bravo(a) comigo quando erro',
                    'Eu aceito ajuda dos outros',
                    'Eu me divirto mesmo quando n√£o sou o(a) melhor'
                ]
            },
            servidor: {
                name: 'Servidor',
                icon: 'ü§ù',
                color: 'bg-yellow-500',
                symptoms: [
                    'Colocar necessidades dos outros sempre √† frente',
                    'Dificuldade em pedir ajuda',
                    'Sensa√ß√£o de culpa ao priorizar-se',
                    'Esgotamento por excesso de compromissos',
                    'Ressentimento n√£o expresso'
                ],
                techniques: [
                    'Exerc√≠cios de prioriza√ß√£o pessoal',
                    'Treino de comunica√ß√£o de necessidades',
                    'Trabalho com culpa',
                    'Estabelecimento de limites claros',
                    'Autocompaix√£o e autocuidado'
                ],
                protocols: {
                    'Destrave Amor Pr√≥prio': 'Valor pr√≥prio independente de servir',
                    'Destrave Relacionamentos': 'Reciprocidade saud√°vel'
                },
                adultQuestions: [
                    'Consigo priorizar minhas necessidades sem culpa',
                    'Pe√ßo ajuda quando preciso',
                    'Digo n√£o a pedidos que me sobrecarregam',
                    'Cuido de mim com a mesma dedica√ß√£o que cuido dos outros',
                    'N√£o sinto que preciso fazer tudo sozinho(a)'
                ],
                childQuestions: [
                    'Eu deixo outros me ajudarem',
                    'Eu brinco tamb√©m, n√£o s√≥ ajudo',
                    'N√£o me sinto mal quando fa√ßo algo para mim',
                    'Eu sei que n√£o preciso fazer tudo sozinho(a)',
                    'Eu pe√ßo ajuda quando preciso'
                ]
            },
            vitima: {
                name: 'V√≠tima',
                icon: 'üòî',
                color: 'bg-red-500',
                symptoms: [
                    'Atribui√ß√£o de controle externo sobre a vida',
                    'Dificuldade em assumir responsabilidade',
                    'Foco em injusti√ßas e problemas',
                    'Sensa√ß√£o de impot√™ncia',
                    'Narrativa de sofrimento constante'
                ],
                techniques: [
                    'Reestrutura√ß√£o de l√≥cus de controle',
                    'Identifica√ß√£o de ag√™ncia pessoal',
                    'Trabalho com responsabilidade vs culpa',
                    'Narrativa de supera√ß√£o',
                    'Exerc√≠cios de empoderamento'
                ],
                protocols: {
                    'Destrave Pais': 'Liberar padr√µes de vitimiza√ß√£o familiar',
                    'Destrave Amor Pr√≥prio': 'Reconhecer for√ßa pessoal'
                },
                adultQuestions: [
                    'Reconhe√ßo meu papel nas situa√ß√µes que vivo',
                    'Foco em solu√ß√µes mais que em problemas',
                    'Me sinto capaz de mudar minha realidade',
                    'N√£o culpo sempre fatores externos',
                    'Celebro minha capacidade de supera√ß√£o'
                ],
                childQuestions: [
                    'Eu acho que posso mudar coisas na minha vida',
                    'Quando algo d√° errado, eu penso no que posso fazer',
                    'N√£o fico s√≥ reclamando dos problemas',
                    'Eu sei que posso fazer coisas boas acontecerem',
                    'N√£o culpo sempre os outros quando algo ruim acontece'
                ]
            },
            paterna: {
                name: 'Paterna',
                icon: 'üë®‚Äçüë©‚Äçüëß',
                color: 'bg-indigo-500',
                symptoms: [
                    'Repeti√ß√£o de padr√µes familiares disfuncionais',
                    'Dificuldade em estabelecer identidade pr√≥pria',
                    'Medo de decepcionar figuras parentais',
                    'Conflitos n√£o resolvidos com pais',
                    'Cren√ßas limitantes herdadas'
                ],
                techniques: [
                    'Trabalho com genograma familiar',
                    'T√©cnicas de diferencia√ß√£o (Bowen)',
                    'Carta terap√™utica (n√£o enviada)',
                    'Ressignifica√ß√£o de mem√≥rias',
                    'Desenvolvimento de identidade pr√≥pria'
                ],
                protocols: {
                    'Destrave Pais': 'Ressignificar rela√ß√£o com figuras parentais',
                    'Destrave Relacionamentos': 'Padr√µes relacionais saud√°veis'
                },
                adultQuestions: [
                    'Tomo decis√µes baseadas em meus valores, n√£o apenas nos dos meus pais',
                    'Reconhe√ßo influ√™ncias familiares sem ser controlado(a) por elas',
                    'Tenho relacionamentos saud√°veis independente do modelo parental',
                    'Me sinto livre para escolher meu pr√≥prio caminho',
                    'Perdoei ou estou em paz com quest√µes familiares'
                ],
                childQuestions: [
                    'Eu posso gostar de coisas diferentes dos meus pais',
                    'N√£o tenho muito medo de deixar meus pais chateados',
                    'Eu me sinto amado(a) mesmo quando erro',
                    'Posso falar sobre meus sentimentos em casa',
                    'N√£o preciso ser igual aos meus pais quando crescer'
                ]
            },
            competencia: {
                name: 'Compet√™ncia',
                icon: 'üéØ',
                color: 'bg-teal-500',
                symptoms: [
                    'Medo de ser considerado incompetente',
                    'S√≠ndrome do impostor',
                    'Necessidade de saber tudo antes de agir',
                    'Evita√ß√£o de novas √°reas de aprendizado',
                    'Ansiedade de desempenho'
                ],
                techniques: [
                    'Reestrutura√ß√£o de cren√ßas sobre compet√™ncia',
                    'Exposi√ß√£o gradual a situa√ß√µes de aprendizado',
                    'Normaliza√ß√£o de erros como parte do processo',
                    'Desenvolvimento de mentalidade de crescimento',
                    'Celebra√ß√£o de tentativas vs resultados'
                ],
                protocols: {
                    'Destrave Amor Pr√≥prio': 'Valor al√©m da compet√™ncia',
                    'Destrave Pais': 'Liberar press√µes por performance'
                },
                adultQuestions: [
                    'Me sinto confort√°vel aprendendo coisas novas',
                    'Aceito que n√£o preciso saber tudo',
                    'N√£o sinto que sou uma fraude em minha √°rea',
                    'Pe√ßo ajuda quando n√£o sei algo',
                    'Celebro meu aprendizado cont√≠nuo'
                ],
                childQuestions: [
                    'Eu gosto de aprender coisas novas',
                    'N√£o tenho medo de perguntar quando n√£o sei',
                    'N√£o me sinto burro(a) quando erro',
                    'Eu tento coisas novas mesmo sem saber fazer',
                    'N√£o preciso ser o(a) melhor da turma'
                ]
            },
            procrastinacao: {
                name: 'Procrastina√ß√£o',
                icon: '‚è∞',
                color: 'bg-orange-500',
                symptoms: [
                    'Adiamento cr√¥nico de tarefas importantes',
                    'Prefer√™ncia por gratifica√ß√£o imediata',
                    'Ansiedade ao pensar em tarefas pendentes',
                    'Dificuldade em iniciar projetos',
                    'Trabalho de √∫ltima hora recorrente'
                ],
                techniques: [
                    'T√©cnica Pomodoro',
                    'Quebra de tarefas em passos pequenos',
                    'Identifica√ß√£o de gatilhos emocionais',
                    'Trabalho com perfeccionismo subjacente',
                    'Sistema de recompensas progressivas'
                ],
                protocols: {
                    'Destrave Amor Pr√≥prio': 'Reduzir autocr√≠tica paralisante',
                    'Destrave Ambiente': 'Organizar contexto facilitador'
                },
                adultQuestions: [
                    'Inicio tarefas importantes sem adi√°-las',
                    'N√£o deixo tudo para √∫ltima hora',
                    'Consigo trabalhar mesmo quando n√£o estou "com vontade"',
                    'N√£o me distraio facilmente de responsabilidades',
                    'Mantenho compromissos comigo mesmo(a)'
                ],
                childQuestions: [
                    'Eu fa√ßo minha li√ß√£o de casa sem ficar enrolando',
                    'N√£o deixo tudo para √∫ltima hora',
                    'Consigo come√ßar tarefas mesmo quando s√£o chatas',
                    'N√£o fico vendo TV quando tenho coisas para fazer',
                    'Termino o que come√ßo'
                ]
            },
            ambiente: {
                name: 'Ambiente',
                icon: 'üè†',
                color: 'bg-cyan-500',
                symptoms: [
                    'Sensa√ß√£o de n√£o pertencimento',
                    'Desconforto cr√¥nico em ambientes sociais/profissionais',
                    'Dificuldade em adaptar-se a novos contextos',
                    'Conflitos recorrentes no ambiente',
                    'Sensa√ß√£o de estar "no lugar errado"'
                ],
                techniques: [
                    'An√°lise de adequa√ß√£o pessoa-ambiente',
                    'Desenvolvimento de habilidades sociais',
                    'Trabalho com identidade e valores',
                    'Estrat√©gias de adapta√ß√£o saud√°vel',
                    'Explora√ß√£o de novos contextos'
                ],
                protocols: {
                    'Destrave Relacionamentos': 'Melhorar intera√ß√µes sociais',
                    'Destrave Amor Pr√≥prio': 'Autenticidade em contextos diversos'
                },
                adultQuestions: [
                    'Me sinto confort√°vel nos ambientes que frequento',
                    'Consigo me adaptar a novos lugares e grupos',
                    'Tenho relacionamentos positivos onde estou',
                    'N√£o sinto que "n√£o perten√ßo"',
                    'Escolho ambientes alinhados com meus valores'
                ],
                childQuestions: [
                    'Eu gosto da minha escola',
                    'Tenho amigos que gostam de mim',
                    'N√£o me sinto estranho(a) perto de outras crian√ßas',
                    'Me sinto bem em casa',
                    'Gosto de participar de atividades com outras pessoas'
                ]
            }
        };

        // IndexedDB Setup
        let db;
        const DB_NAME = 'TravasMentaisDB';
        const DB_VERSION = 1;

        function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);

                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };

                request.onupgradeneeded = (event) => {
                    const database = event.target.result;

                    if (!database.objectStoreNames.contains('patients')) {
                        database.createObjectStore('patients', { keyPath: 'name' });
                    }

                    if (!database.objectStoreNames.contains('assessments')) {
                        database.createObjectStore('assessments', { keyPath: 'id' });
                    }

                    if (!database.objectStoreNames.contains('confidentiality')) {
                        database.createObjectStore('confidentiality', { keyPath: 'id' });
                    }
                };
            });
        }

        // Application state
        let appState = {
            currentPage: 'home',
            currentBlock: null,
            patients: [],
            currentPatient: null,
            assessments: [],
            confidentialityAgreements: []
        };

        // Load data from IndexedDB
        async function loadData() {
            try {
                const patientsTransaction = db.transaction(['patients'], 'readonly');
                const patientsStore = patientsTransaction.objectStore('patients');
                const patientsRequest = patientsStore.getAll();

                const assessmentsTransaction = db.transaction(['assessments'], 'readonly');
                const assessmentsStore = assessmentsTransaction.objectStore('assessments');
                const assessmentsRequest = assessmentsStore.getAll();

                const confidentialityTransaction = db.transaction(['confidentiality'], 'readonly');
                const confidentialityStore = confidentialityTransaction.objectStore('confidentiality');
                const confidentialityRequest = confidentialityStore.getAll();

                patientsRequest.onsuccess = () => {
                    appState.patients = patientsRequest.result || [];
                };

                assessmentsRequest.onsuccess = () => {
                    appState.assessments = assessmentsRequest.result || [];
                };

                confidentialityRequest.onsuccess = () => {
                    appState.confidentialityAgreements = confidentialityRequest.result || [];
                    render();
                };
            } catch (error) {
                console.log('Error loading data:', JSON.stringify({ message: error.message }));
            }
        }

        // Save state to IndexedDB
        function saveState() {
            if (!db) return;

            try {
                // Save patients
                const patientsTransaction = db.transaction(['patients'], 'readwrite');
                const patientsStore = patientsTransaction.objectStore('patients');
                appState.patients.forEach(patient => {
                    patientsStore.put(patient);
                });

                // Save assessments
                const assessmentsTransaction = db.transaction(['assessments'], 'readwrite');
                const assessmentsStore = assessmentsTransaction.objectStore('assessments');
                appState.assessments.forEach(assessment => {
                    assessmentsStore.put(assessment);
                });

                // Save confidentiality agreements
                const confidentialityTransaction = db.transaction(['confidentiality'], 'readwrite');
                const confidentialityStore = confidentialityTransaction.objectStore('confidentiality');
                appState.confidentialityAgreements.forEach(agreement => {
                    confidentialityStore.put(agreement);
                });
            } catch (error) {
                console.log('Error saving data:', JSON.stringify({ message: error.message }));
            }
        }

        // Navigation
        function navigateTo(page, data = null) {
            appState.currentPage = page;
            if (data) {
                if (data.block) appState.currentBlock = data.block;
                if (data.patient) appState.currentPatient = data.patient;
            }
            render();
        }

        // Custom modals
        function showModal(title, content, actions = []) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 fade-in';
            modal.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="p-6">
                        <h3 class="text-xl font-bold mb-4 text-gray-900 dark:text-white">${title}</h3>
                        <div class="text-gray-700 dark:text-gray-300 mb-6">${content}</div>
                        <div class="flex justify-end gap-3">
                            ${actions.map(action => `
                                <button onclick="${action.onClick}" class="px-4 py-2 ${action.className || 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600'} rounded-lg transition">
                                    ${action.label}
                                </button>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            document.getElementById('modalContainer').innerHTML = '';
            document.getElementById('modalContainer').appendChild(modal);
        }

        function closeModal() {
            document.getElementById('modalContainer').innerHTML = '';
        }

        // Patient Registration Form
        function showPatientRegistrationForm() {
            const formId = 'patient-reg-form-' + Date.now();
            showModal('Cadastro de Paciente', `
                <form id="${formId}" class="space-y-4">
                    <div>
                        <label class="block mb-2 font-medium">Nome Completo *</label>
                        <input type="text" name="fullName" required
                            class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg
                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">Data de Nascimento</label>
                        <input type="date" name="birthDate"
                            class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg
                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">Email</label>
                        <input type="email" name="email"
                            class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg
                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">Telefone</label>
                        <input type="tel" name="phone"
                            class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg
                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                    </div>
                    <div>
                        <label class="block mb-2 font-medium">Observa√ß√µes</label>
                        <textarea name="notes" rows="3"
                            class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg
                            bg-white dark:bg-gray-700 text-gray-900 dark:text-white"></textarea>
                    </div>
                </form>
            `, [
                { label: 'Cancelar', onClick: 'closeModal()' },
                {
                    label: 'Cadastrar',
                    onClick: `submitPatientRegistration('${formId}')`,
                    className: 'bg-primary text-white hover:bg-primary/90'
                }
            ]);
        }

        function submitPatientRegistration(formId) {
            const form = document.getElementById(formId);
            if (!form.checkValidity()) {
                showModal('Aten√ß√£o', '<p>Por favor, preencha todos os campos obrigat√≥rios.</p>', [
                    { label: 'OK', onClick: 'closeModal()' }
                ]);
                return;
            }

            const formData = new FormData(form);
            const patientData = {
                name: formData.get('fullName'),
                fullName: formData.get('fullName'),
                birthDate: formData.get('birthDate'),
                email: formData.get('email'),
                phone: formData.get('phone'),
                notes: formData.get('notes'),
                createdAt: new Date().toISOString(),
                assessments: []
            };

            // Check if patient already exists
            const existingPatient = appState.patients.find(p => p.name === patientData.name);
            if (existingPatient) {
                showModal('Paciente j√° existe', '<p>J√° existe um paciente cadastrado com este nome.</p>', [
                    { label: 'OK', onClick: 'closeModal()' }
                ]);
                return;
            }

            appState.patients.push(patientData);
            saveState();
            closeModal();

            // Ask if user wants to sign confidentiality agreement
            showConfirmDialog('Deseja prosseguir com o Termo de Confidencialidade para este paciente?', () => {
                showConfidentialityAgreement(patientData.name);
            });
        }

        // Confidentiality Agreement
        function showConfidentialityAgreement(patientName) {
            const agreementId = 'agreement-' + Date.now();
            showModal('Termo de Confidencialidade e Consentimento', `
                <div class="space-y-4 text-sm">
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg max-h-60 overflow-y-auto">
                        <h4 class="font-bold mb-2">TERMO DE CONFIDENCIALIDADE E CONSENTIMENTO INFORMADO</h4>
                        <p class="mb-2"><strong>Paciente:</strong> ${patientName}</p>
                        <p class="mb-2"><strong>Data:</strong> ${new Date().toLocaleDateString('pt-BR')}</p>

                        <h5 class="font-bold mt-4 mb-2">1. CONFIDENCIALIDADE</h5>
                        <p class="mb-2">Todas as informa√ß√µes compartilhadas durante as sess√µes terap√™uticas s√£o estritamente confidenciais e protegidas pelo sigilo profissional, conforme estabelecido pelo C√≥digo de √âtica Profissional.</p>

                        <h5 class="font-bold mt-4 mb-2">2. EXCE√á√ïES √Ä CONFIDENCIALIDADE</h5>
                        <p class="mb-2">O sigilo poder√° ser quebrado em situa√ß√µes de:</p>
                        <ul class="list-disc pl-5 mb-2">
                            <li>Risco iminente de vida do paciente ou de terceiros</li>
                            <li>Suspeita de abuso ou maus-tratos a menores ou idosos</li>
                            <li>Determina√ß√£o judicial</li>
                        </ul>

                        <h5 class="font-bold mt-4 mb-2">3. ARMAZENAMENTO DE DADOS</h5>
                        <p class="mb-2">Os dados coletados durante as avalia√ß√µes ser√£o armazenados de forma segura e utilizados exclusivamente para fins terap√™uticos.</p>

                        <h5 class="font-bold mt-4 mb-2">4. CONSENTIMENTO</h5>
                        <p class="mb-2">Ao assinar este termo, declaro estar ciente e de acordo com as condi√ß√µes acima estabelecidas.</p>
                    </div>

                    <form id="${agreementId}" class="space-y-3">
                        <div>
                            <label class="block mb-2 font-medium">Nome do Paciente/Respons√°vel *</label>
                            <input type="text" name="patientSignature" value="${patientName}" required
                                class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg
                                bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div>
                            <label class="block mb-2 font-medium">Nome do Terapeuta *</label>
                            <input type="text" name="therapistSignature" required
                                class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg
                                bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
                        </div>
                        <div class="flex items-start gap-2">
                            <input type="checkbox" name="consent" required id="consent-${agreementId}"
                                class="mt-1 w-4 h-4">
                            <label for="consent-${agreementId}" class="text-sm">
                                Declaro ter lido e concordado com todos os termos acima
                            </label>
                        </div>
                    </form>
                </div>
            `, [
                { label: 'Cancelar', onClick: 'closeModal()' },
                {
                    label: 'Assinar e Confirmar',
                    onClick: `submitConfidentialityAgreement('${agreementId}', '${patientName}')`,
                    className: 'bg-primary text-white hover:bg-primary/90'
                }
            ]);
        }

        function submitConfidentialityAgreement(formId, patientName) {
            const form = document.getElementById(formId);
            if (!form.checkValidity()) {
                showModal('Aten√ß√£o', '<p>Por favor, preencha todos os campos e aceite os termos.</p>', [
                    { label: 'OK', onClick: 'closeModal()' }
                ]);
                return;
            }

            const formData = new FormData(form);
            const agreement = {
                id: Date.now(),
                patientName: patientName,
                patientSignature: formData.get('patientSignature'),
                therapistSignature: formData.get('therapistSignature'),
                signedAt: new Date().toISOString(),
                consent: true
            };

            appState.confidentialityAgreements.push(agreement);
            saveState();
            closeModal();

            showModal('Termo Assinado com Sucesso', `
                <p class="mb-4">O termo de confidencialidade foi assinado e armazenado com sucesso.</p>
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded">
                    <p><strong>Paciente:</strong> ${agreement.patientName}</p>
                    <p><strong>Data:</strong> ${new Date(agreement.signedAt).toLocaleString('pt-BR')}</p>
                </div>
            `, [
                { label: 'OK', onClick: 'closeModal(); navigateTo("patients")', className: 'bg-primary text-white hover:bg-primary/90' }
            ]);
        }

        function showConfirmDialog(message, onConfirm) {
            showModal('Confirmar', `<p>${message}</p>`, [
                { label: 'Cancelar', onClick: 'closeModal()', className: 'bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600' },
                { label: 'Confirmar', onClick: `closeModal(); (${onConfirm.toString()})()`, className: 'bg-primary text-white hover:bg-primary/90' }
            ]);
        }

        function showInputDialog(title, placeholder, onSubmit) {
            const inputId = 'modal-input-' + Date.now();
            showModal(title, `
                <input id="${inputId}" type="text" placeholder="${placeholder}"
                    class="w-full px-4 py-2 text-base border border-gray-300 dark:border-gray-600 rounded-lg
                    bg-white dark:bg-gray-700 text-gray-900 dark:text-white">
            `, [
                { label: 'Cancelar', onClick: 'closeModal()' },
                {
                    label: 'Confirmar',
                    onClick: `const val = document.getElementById('${inputId}').value; if(val) { closeModal(); (${onSubmit.toString()})(val); } else { alert('Por favor preencha o campo'); }`,
                    className: 'bg-primary text-white hover:bg-primary/90'
                }
            ]);
            setTimeout(() => document.getElementById(inputId).focus(), 100);
        }

        // Get color for intensity value
        function getIntensityColor(value) {
            if (value <= 3) return 'bg-green-500 text-white';
            if (value <= 6) return 'bg-yellow-500 text-gray-900';
            return 'bg-red-500 text-white';
        }

        // Calculate intensity
        function calculateIntensity(values) {
            const sum = values.reduce((a, b) => a + b, 0);
            const avg = sum / values.length;
            return {
                sum: sum,
                average: avg.toFixed(2),
                level: avg <= 3.3 ? 'Baixa' : avg <= 6.6 ? 'M√©dia' : 'Alta'
            };
        }

        // Render functions
        function renderHome() {
            return `
                <div class="fade-in">
                    <h2 class="text-3xl font-bold mb-6">Travas Mentais</h2>
                    <p class="text-gray-600 dark:text-gray-400 mb-8">
                        Selecione uma trava mental para visualizar sintomas, t√©cnicas e realizar avalia√ß√µes.
                    </p>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-4">
                        ${Object.keys(mentalBlocks).map(key => {
                            const block = mentalBlocks[key];
                            return `
                                <div onclick="navigateTo('block', {block: '${key}'})"
                                    class="scale-card ${block.color} text-white p-6 rounded-xl shadow-lg cursor-pointer">
                                    <div class="text-4xl mb-3">${block.icon}</div>
                                    <h3 class="text-lg font-bold">${block.name}</h3>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderBlock() {
            const block = mentalBlocks[appState.currentBlock];
            if (!block) return renderHome();

            return `
                <div class="fade-in">
                    <button onclick="navigateTo('home')" class="mb-4 text-primary hover:underline">
                        ‚Üê Voltar
                    </button>

                    <div class="${block.color} text-white p-8 rounded-xl shadow-lg mb-6">
                        <div class="flex items-center gap-4">
                            <div class="text-6xl">${block.icon}</div>
                            <div>
                                <h2 class="text-3xl font-bold">${block.name}</h2>
                                <p class="opacity-90">An√°lise e interven√ß√£o</p>
                            </div>
                        </div>
                    </div>

                    <!-- Tabs -->
                    <div class="mb-6 border-b border-gray-200 dark:border-gray-700">
                        <div class="flex flex-wrap gap-2">
                            <button onclick="showTab('symptoms')" id="tab-symptoms"
                                class="tab-btn px-4 py-2 text-base font-medium border-b-2 border-transparent hover:border-primary transition">
                                Sintomas
                            </button>
                            <button onclick="showTab('techniques')" id="tab-techniques"
                                class="tab-btn px-4 py-2 text-base font-medium border-b-2 border-transparent hover:border-primary transition">
                                T√©cnicas
                            </button>
                            <button onclick="showTab('protocols')" id="tab-protocols"
                                class="tab-btn px-4 py-2 text-base font-medium border-b-2 border-transparent hover:border-primary transition">
                                Protocolos
                            </button>
                            <button onclick="showTab('assessment-adult')" id="tab-assessment-adult"
                                class="tab-btn px-4 py-2 text-base font-medium border-b-2 border-transparent hover:border-primary transition">
                                Avalia√ß√£o Adulto
                            </button>
                            <button onclick="showTab('assessment-child')" id="tab-assessment-child"
                                class="tab-btn px-4 py-2 text-base font-medium border-b-2 border-transparent hover:border-primary transition">
                                Avalia√ß√£o Infantil
                            </button>
                        </div>
                    </div>

                    <div id="tab-content">
                        <!-- Tab content will be rendered here -->
                    </div>
                </div>
            `;
        }

        function showTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('border-primary', 'text-primary');
            });
            const activeTab = document.getElementById('tab-' + tabName);
            if (activeTab) {
                activeTab.classList.add('border-primary', 'text-primary');
            }

            const block = mentalBlocks[appState.currentBlock];
            const content = document.getElementById('tab-content');

            if (tabName === 'symptoms') {
                content.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">Sintomas Caracter√≠sticos</h3>
                        <ul class="space-y-3">
                            ${block.symptoms.map(s => `
                                <li class="flex items-start gap-3">
                                    <span class="text-primary mt-1">‚óè</span>
                                    <span>${s}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else if (tabName === 'techniques') {
                content.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">T√©cnicas de Interven√ß√£o</h3>
                        <ul class="space-y-3">
                            ${block.techniques.map(t => `
                                <li class="flex items-start gap-3">
                                    <span class="text-primary mt-1">‚úì</span>
                                    <span>${t}</span>
                                </li>
                            `).join('')}
                        </ul>
                    </div>
                `;
            } else if (tabName === 'protocols') {
                content.innerHTML = `
                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                        <h3 class="text-xl font-bold mb-4">Protocolos de Tratamento</h3>
                        <div class="space-y-4">
                            ${Object.entries(block.protocols).map(([protocol, description]) => `
                                <div class="border-l-4 border-primary pl-4 py-2">
                                    <h4 class="font-bold text-lg">${protocol}</h4>
                                    <p class="text-gray-600 dark:text-gray-400">${description}</p>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            } else if (tabName === 'assessment-adult') {
                content.innerHTML = renderAssessmentForm('adult');
            } else if (tabName === 'assessment-child') {
                content.innerHTML = renderAssessmentForm('child');
            }
        }

        function renderAssessmentForm(type) {
            const block = mentalBlocks[appState.currentBlock];
            const questions = type === 'adult' ? block.adultQuestions : block.childQuestions;
            const title = type === 'adult' ? 'Avalia√ß√£o Adulto' : 'Avalia√ß√£o Infantil';
            const description = type === 'adult'
                ? 'Avalie cada afirma√ß√£o de 1 (discordo totalmente) a 10 (concordo totalmente)'
                : 'Perguntas adaptadas para crian√ßas (TDAH, TEA, TOP). Escala: 1 (nunca) a 10 (sempre)';

            return `
                <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                    <h3 class="text-xl font-bold mb-2">${title}</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">${description}</p>

                    <form id="assessment-form-${type}" onsubmit="submitAssessment(event, '${type}')" class="space-y-6">
                        ${questions.map((q, i) => `
                            <div class="border-b border-gray-200 dark:border-gray-700 pb-4">
                                <label class="block mb-3 font-medium">${i + 1}. ${q}</label>
                                <div class="flex items-center gap-2">
                                    <span class="text-sm text-gray-500">1</span>
                                    <input type="range" min="1" max="10" value="5"
                                        id="${type}-q${i}" name="q${i}"
                                        oninput="updateRangeDisplay('${type}-q${i}')"
                                        class="flex-1 h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer dark:bg-gray-700">
                                    <span class="text-sm text-gray-500">10</span>
                                    <span id="${type}-q${i}-value"
                                        class="ml-3 px-3 py-1 rounded font-bold min-w-[60px] text-center ${getIntensityColor(5)}">
                                        5
                                    </span>
                                </div>
                            </div>
                        `).join('')}

                        <div class="bg-gray-100 dark:bg-gray-900 p-4 rounded-lg" id="${type}-result">
                            <p class="text-center text-gray-600 dark:text-gray-400">
                                Complete a avalia√ß√£o para ver o resultado
                            </p>
                        </div>

                        <div class="flex gap-3">
                            <button type="button" onclick="calculateAssessmentPreview('${type}')"
                                class="flex-1 px-6 py-3 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg font-medium transition">
                                Calcular Intensidade
                            </button>
                            <button type="submit"
                                class="flex-1 px-6 py-3 bg-primary text-white hover:bg-primary/90 rounded-lg font-medium transition">
                                Salvar Avalia√ß√£o
                            </button>
                        </div>
                    </form>
                </div>
            `;
        }

        function updateRangeDisplay(id) {
            const input = document.getElementById(id);
            const display = document.getElementById(id + '-value');
            const value = parseInt(input.value);
            display.textContent = value;
            display.className = `ml-3 px-3 py-1 rounded font-bold min-w-[60px] text-center ${getIntensityColor(value)}`;
        }

        function calculateAssessmentPreview(type) {
            const form = document.getElementById('assessment-form-' + type);
            const values = [];
            const inputs = form.querySelectorAll('input[type="range"]');
            inputs.forEach(input => values.push(parseInt(input.value)));

            const result = calculateIntensity(values);
            const resultDiv = document.getElementById(type + '-result');
            resultDiv.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 text-center">
                    <div>
                        <div class="text-2xl font-bold text-primary">${result.sum}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Pontua√ß√£o Total</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold text-primary">${result.average}</div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">M√©dia</div>
                    </div>
                    <div>
                        <div class="text-2xl font-bold ${result.level === 'Baixa' ? 'text-green-500' : result.level === 'M√©dia' ? 'text-yellow-500' : 'text-red-500'}">
                            ${result.level}
                        </div>
                        <div class="text-sm text-gray-600 dark:text-gray-400">Intensidade</div>
                    </div>
                </div>
            `;
        }

        function submitAssessment(event, type) {
            event.preventDefault();

            if (!appState.currentPatient) {
                showInputDialog('Identificar Paciente', 'Nome ou iniciais do paciente', (patientName) => {
                    saveAssessmentWithPatient(type, patientName);
                });
            } else {
                saveAssessmentWithPatient(type, appState.currentPatient);
            }
        }

        function saveAssessmentWithPatient(type, patientName) {
            const form = document.getElementById('assessment-form-' + type);
            const values = [];
            const inputs = form.querySelectorAll('input[type="range"]');
            inputs.forEach(input => values.push(parseInt(input.value)));

            const result = calculateIntensity(values);

            const assessment = {
                id: Date.now(),
                patientName: patientName,
                block: appState.currentBlock,
                blockName: mentalBlocks[appState.currentBlock].name,
                type: type,
                date: new Date().toISOString(),
                values: values,
                result: result
            };

            appState.assessments.push(assessment);

            // Add or update patient
            let patient = appState.patients.find(p => p.name === patientName);
            if (!patient) {
                patient = {
                    name: patientName,
                    createdAt: new Date().toISOString(),
                    assessments: []
                };
                appState.patients.push(patient);
            }

            saveState();

            showModal('Avalia√ß√£o Salva', `
                <p class="mb-4">A avalia√ß√£o foi salva com sucesso!</p>
                <div class="bg-gray-100 dark:bg-gray-800 p-4 rounded">
                    <p><strong>Paciente:</strong> ${patientName}</p>
                    <p><strong>Trava:</strong> ${mentalBlocks[appState.currentBlock].name}</p>
                    <p><strong>Tipo:</strong> ${type === 'adult' ? 'Adulto' : 'Infantil'}</p>
                    <p><strong>Intensidade:</strong> ${result.level} (${result.average})</p>
                </div>
            `, [
                { label: 'OK', onClick: 'closeModal()', className: 'bg-primary text-white hover:bg-primary/90' }
            ]);
        }

        function renderPatients() {
            if (appState.patients.length === 0) {
                return `
                    <div class="fade-in text-center py-16">
                        <div class="text-6xl mb-4">üë•</div>
                        <h2 class="text-2xl font-bold mb-2">Nenhum paciente cadastrado</h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">
                            As avalia√ß√µes salvas criar√£o automaticamente os perfis de pacientes
                        </p>
                        <button onclick="navigateTo('home')"
                            class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                            Ir para Travas Mentais
                        </button>
                    </div>
                `;
            }

            return `
                <div class="fade-in">
                    <h2 class="text-3xl font-bold mb-6">Pacientes</h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        ${appState.patients.map(patient => {
                            const patientAssessments = appState.assessments.filter(a => a.patientName === patient.name);
                            return `
                                <div onclick="navigateTo('patient-detail', {patient: '${patient.name}'})"
                                    class="scale-card bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg cursor-pointer hover:shadow-xl transition">
                                    <h3 class="text-xl font-bold mb-2">${patient.name}</h3>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                                        Cadastrado em ${new Date(patient.createdAt).toLocaleDateString('pt-BR')}
                                    </p>
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm">${patientAssessments.length} avalia√ß√µes</span>
                                        <span class="text-primary">Ver detalhes ‚Üí</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            `;
        }

        function renderPatientDetail() {
            const patientAssessments = appState.assessments.filter(a => a.patientName === appState.currentPatient);

            if (patientAssessments.length === 0) {
                return `
                    <div class="fade-in">
                        <button onclick="navigateTo('patients')" class="mb-4 text-primary hover:underline">
                            ‚Üê Voltar
                        </button>
                        <h2 class="text-3xl font-bold mb-6">${appState.currentPatient}</h2>
                        <p class="text-gray-600 dark:text-gray-400">Nenhuma avalia√ß√£o encontrada para este paciente.</p>
                    </div>
                `;
            }

            // Group by block
            const byBlock = {};
            patientAssessments.forEach(a => {
                if (!byBlock[a.blockName]) byBlock[a.blockName] = [];
                byBlock[a.blockName].push(a);
            });

            return `
                <div class="fade-in">
                    <button onclick="navigateTo('patients')" class="mb-4 text-primary hover:underline">
                        ‚Üê Voltar
                    </button>

                    <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg mb-6">
                        <h2 class="text-3xl font-bold mb-2">${appState.currentPatient}</h2>
                        <p class="text-gray-600 dark:text-gray-400">
                            ${patientAssessments.length} avalia√ß√µes realizadas
                        </p>
                        <div class="mt-4 flex flex-wrap gap-2">
                            <button onclick="generateFinalReport('${appState.currentPatient}')"
                                class="px-4 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                                üìã Gerar Relat√≥rio Final
                            </button>
                            <button onclick="printPatientData('${appState.currentPatient}')"
                                class="px-4 py-2 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transition">
                                üñ®Ô∏è Imprimir
                            </button>
                            <button onclick="exportPatientData('${appState.currentPatient}', 'csv')"
                                class="px-4 py-2 bg-green-500 text-white rounded-lg hover:bg-green-600 transition">
                                üìä Exportar CSV
                            </button>
                            <button onclick="exportPatientData('${appState.currentPatient}', 'json')"
                                class="px-4 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
                                üìÑ Exportar JSON
                            </button>
                        </div>
                    </div>

                    <h3 class="text-2xl font-bold mb-4">Hist√≥rico de Avalia√ß√µes</h3>

                    ${Object.entries(byBlock).map(([blockName, assessments]) => `
                        <div class="mb-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow">
                            <h4 class="text-xl font-bold mb-4">${blockName}</h4>
                            <div class="space-y-4">
                                ${assessments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(a => `
                                    <div class="border-l-4 border-primary pl-4 py-2">
                                        <div class="flex justify-between items-start flex-wrap gap-2">
                                            <div>
                                                <p class="font-medium">
                                                    ${a.type === 'adult' ? 'üë§ Avalia√ß√£o Adulto' : 'üë∂ Avalia√ß√£o Infantil'}
                                                </p>
                                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                                    ${new Date(a.date).toLocaleString('pt-BR')}
                                                </p>
                                            </div>
                                            <div class="text-right">
                                                <p class="text-2xl font-bold ${a.result.level === 'Baixa' ? 'text-green-500' : a.result.level === 'M√©dia' ? 'text-yellow-500' : 'text-red-500'}">
                                                    ${a.result.average}
                                                </p>
                                                <p class="text-sm">${a.result.level}</p>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        function renderAnalytics() {
            if (appState.assessments.length === 0) {
                return `
                    <div class="fade-in text-center py-16">
                        <div class="text-6xl mb-4">üìä</div>
                        <h2 class="text-2xl font-bold mb-2">Nenhum dado dispon√≠vel</h2>
                        <p class="text-gray-600 dark:text-gray-400 mb-6">
                            Realize avalia√ß√µes para visualizar an√°lises estat√≠sticas
                        </p>
                        <button onclick="navigateTo('home')"
                            class="px-6 py-3 bg-primary text-white rounded-lg hover:bg-primary/90 transition">
                            Realizar Avalia√ß√µes
                        </button>
                    </div>
                `;
            }

            // Calculate statistics
            const totalAssessments = appState.assessments.length;
            const uniquePatients = new Set(appState.assessments.map(a => a.patientName)).size;

            // Count by block
            const blockCounts = {};
            const blockAverages = {};
            Object.keys(mentalBlocks).forEach(key => {
                const blockAssessments = appState.assessments.filter(a => a.block === key);
                blockCounts[mentalBlocks[key].name] = blockAssessments.length;
                if (blockAssessments.length > 0) {
                    const avg = blockAssessments.reduce((sum, a) => sum + parseFloat(a.result.average), 0) / blockAssessments.length;
                    blockAverages[mentalBlocks[key].name] = avg.toFixed(2);
                }
            });

            setTimeout(() => {
                renderCharts(blockCounts, blockAverages);
            }, 100);

            return `
                <div class="fade-in">
                    <h2 class="text-3xl font-bold mb-6">Analytics</h2>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="text-3xl font-bold text-primary">${totalAssessments}</div>
                            <div class="text-gray-600 dark:text-gray-400">Total de Avalia√ß√µes</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="text-3xl font-bold text-primary">${uniquePatients}</div>
                            <div class="text-gray-600 dark:text-gray-400">Pacientes √önicos</div>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <div class="text-3xl font-bold text-primary">${Object.keys(blockCounts).filter(k => blockCounts[k] > 0).length}</div>
                            <div class="text-gray-600 dark:text-gray-400">Travas Avaliadas</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Avalia√ß√µes por Trava</h3>
                            <canvas id="blockCountChart"></canvas>
                        </div>
                        <div class="bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                            <h3 class="text-xl font-bold mb-4">Intensidade M√©dia por Trava</h3>
                            <canvas id="blockAverageChart"></canvas>
                        </div>
                    </div>

                    <div class="mt-6 bg-white dark:bg-gray-800 p-6 rounded-lg shadow-lg">
                        <h3 class="text-xl font-bold mb-4">Timeline de Avalia√ß√µes</h3>
                        <div class="space-y-2 max-h-96 overflow-y-auto">
                            ${appState.assessments.sort((a, b) => new Date(b.date) - new Date(a.date)).map(a => `
                                <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-900 rounded">
                                    <div>
                                        <span class="font-medium">${a.patientName}</span>
                                        <span class="text-gray-600 dark:text-gray-400 mx-2">‚Ä¢</span>
                                        <span>${a.blockName}</span>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <span class="text-sm text-gray-600 dark:text-gray-400">
                                            ${new Date(a.date).toLocaleDateString('pt-BR')}
                                        </span>
                                        <span class="px-3 py-1 rounded font-bold ${getIntensityColor(parseFloat(a.result.average))}">
                                            ${a.result.average}
                                        </span>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderCharts(blockCounts, blockAverages) {
            const isDark = document.documentElement.classList.contains('dark');
            const textColor = isDark ? '#e5e7eb' : '#374151';
            const gridColor = isDark ? '#374151' : '#e5e7eb';

            // Count chart
            const ctxCount = document.getElementById('blockCountChart');
            if (ctxCount) {
                new Chart(ctxCount, {
                    type: 'bar',
                    data: {
                        labels: Object.keys(blockCounts),
                        datasets: [{
                            label: 'N√∫mero de Avalia√ß√µes',
                            data: Object.values(blockCounts),
                            backgroundColor: '#5D5CDE',
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: isDark ? '#1f2937' : '#ffffff',
                                titleColor: textColor,
                                bodyColor: textColor,
                                borderColor: gridColor,
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
            }

            // Average chart
            const ctxAvg = document.getElementById('blockAverageChart');
            if (ctxAvg) {
                new Chart(ctxAvg, {
                    type: 'line',
                    data: {
                        labels: Object.keys(blockAverages),
                        datasets: [{
                            label: 'Intensidade M√©dia',
                            data: Object.values(blockAverages),
                            borderColor: '#5D5CDE',
                            backgroundColor: 'rgba(93, 92, 222, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: isDark ? '#1f2937' : '#ffffff',
                                titleColor: textColor,
                                bodyColor: textColor,
                                borderColor: gridColor,
                                borderWidth: 1
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            },
                            x: {
                                ticks: { color: textColor },
                                grid: { color: gridColor }
                            }
                        }
                    }
                });
            }
        }

        function exportPatientData(patientName, format) {
            const patientAssessments = appState.assessments.filter(a => a.patientName === patientName);

            if (format === 'csv') {
                let csv = 'Data,Trava,Tipo,Intensidade M√©dia,N√≠vel,Pontua√ß√£o Total\n';
                patientAssessments.forEach(a => {
                    csv += `${new Date(a.date).toLocaleString('pt-BR')},${a.blockName},${a.type === 'adult' ? 'Adulto' : 'Infantil'},${a.result.average},${a.result.level},${a.result.sum}\n`;
                });
                downloadFile(csv, `${patientName}_avaliacoes.csv`, 'text/csv');
            } else if (format === 'json') {
                const json = JSON.stringify(patientAssessments, null, 2);
                downloadFile(json, `${patientName}_avaliacoes.json`, 'application/json');
            }
        }

        function downloadFile(content, filename, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Generate Final Report for Patient
        function generateFinalReport(patientName) {
            const patient = appState.patients.find(p => p.name === patientName);
            const patientAssessments = appState.assessments.filter(a => a.patientName === patientName);

            if (patientAssessments.length === 0) {
                showModal('Sem Dados', '<p>N√£o h√° avalia√ß√µes suficientes para gerar um relat√≥rio final.</p>', [
                    { label: 'OK', onClick: 'closeModal()' }
                ]);
                return;
            }

            // Calculate statistics
            const blockSummary = {};
            patientAssessments.forEach(a => {
                if (!blockSummary[a.blockName]) {
                    blockSummary[a.blockName] = {
                        count: 0,
                        totalAvg: 0,
                        levels: []
                    };
                }
                blockSummary[a.blockName].count++;
                blockSummary[a.blockName].totalAvg += parseFloat(a.result.average);
                blockSummary[a.blockName].levels.push(a.result.level);
            });

            // Calculate overall average
            let overallSum = 0;
            let overallCount = 0;
            const criticalBlocks = [];
            const improvingBlocks = [];

            Object.keys(blockSummary).forEach(blockName => {
                const avg = blockSummary[blockName].totalAvg / blockSummary[blockName].count;
                blockSummary[blockName].average = avg.toFixed(2);
                overallSum += avg;
                overallCount++;

                if (avg > 6.6) {
                    criticalBlocks.push(blockName);
                } else if (avg <= 3.3) {
                    improvingBlocks.push(blockName);
                }
            });

            const overallAverage = (overallSum / overallCount).toFixed(2);
            const overallLevel = overallAverage <= 3.3 ? 'Baixa' : overallAverage <= 6.6 ? 'M√©dia' : 'Alta';

            // Generate recommendations
            let recommendations = [];
            if (criticalBlocks.length > 0) {
                recommendations.push(`Focar no tratamento das travas: ${criticalBlocks.join(', ')}`);
                criticalBlocks.forEach(blockName => {
                    const blockKey = Object.keys(mentalBlocks).find(k => mentalBlocks[k].name === blockName);
                    if (blockKey && mentalBlocks[blockKey].techniques) {
                        recommendations.push(`Para ${blockName}, considerar: ${mentalBlocks[blockKey].techniques[0]}`);
                    }
                });
            }
            if (improvingBlocks.length > 0) {
                recommendations.push(`Progresso positivo identificado em: ${improvingBlocks.join(', ')}`);
            }

            // Display report
            const reportHtml = `
                <div class="space-y-4">
                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-bold text-lg mb-3">RELAT√ìRIO FINAL DE AVALIA√á√ÉO</h4>
                        <p><strong>Paciente:</strong> ${patientName}</p>
                        <p><strong>Data do Relat√≥rio:</strong> ${new Date().toLocaleString('pt-BR')}</p>
                        <p><strong>Total de Avalia√ß√µes:</strong> ${patientAssessments.length}</p>
                        <p><strong>Per√≠odo:</strong> ${new Date(patientAssessments[patientAssessments.length - 1].date).toLocaleDateString('pt-BR')} at√© ${new Date(patientAssessments[0].date).toLocaleDateString('pt-BR')}</p>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-3">RESUMO GERAL</h4>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Intensidade M√©dia Geral</p>
                                <p class="text-2xl font-bold ${overallLevel === 'Baixa' ? 'text-green-500' : overallLevel === 'M√©dia' ? 'text-yellow-500' : 'text-red-500'}">
                                    ${overallAverage}
                                </p>
                                <p class="text-sm">${overallLevel}</p>
                            </div>
                            <div>
                                <p class="text-sm text-gray-600 dark:text-gray-400">Travas Avaliadas</p>
                                <p class="text-2xl font-bold text-primary">${Object.keys(blockSummary).length}</p>
                            </div>
                        </div>
                    </div>

                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-3">AN√ÅLISE POR TRAVA MENTAL</h4>
                        <div class="space-y-2">
                            ${Object.entries(blockSummary).map(([blockName, data]) => `
                                <div class="border-l-4 ${data.average <= 3.3 ? 'border-green-500' : data.average <= 6.6 ? 'border-yellow-500' : 'border-red-500'} pl-3 py-2">
                                    <div class="flex justify-between items-center">
                                        <span class="font-medium">${blockName}</span>
                                        <span class="font-bold ${data.average <= 3.3 ? 'text-green-500' : data.average <= 6.6 ? 'text-yellow-500' : 'text-red-500'}">
                                            ${data.average}
                                        </span>
                                    </div>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">
                                        ${data.count} avalia√ß√£o(√µes) realizada(s)
                                    </p>
                                </div>
                            `).join('')}
                        </div>
                    </div>

                    ${criticalBlocks.length > 0 ? `
                    <div class="bg-red-50 dark:bg-red-900/20 border-l-4 border-red-500 p-4 rounded">
                        <h4 class="font-bold mb-2 text-red-700 dark:text-red-400">‚ö†Ô∏è √ÅREAS DE ATEN√á√ÉO PRIORIT√ÅRIA</h4>
                        <ul class="list-disc pl-5 text-sm">
                            ${criticalBlocks.map(b => `<li>${b}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    ${improvingBlocks.length > 0 ? `
                    <div class="bg-green-50 dark:bg-green-900/20 border-l-4 border-green-500 p-4 rounded">
                        <h4 class="font-bold mb-2 text-green-700 dark:text-green-400">‚úÖ √ÅREAS COM PROGRESSO</h4>
                        <ul class="list-disc pl-5 text-sm">
                            ${improvingBlocks.map(b => `<li>${b}</li>`).join('')}
                        </ul>
                    </div>
                    ` : ''}

                    <div class="bg-gray-50 dark:bg-gray-900 p-4 rounded-lg">
                        <h4 class="font-bold mb-3">RECOMENDA√á√ïES TERAP√äUTICAS</h4>
                        <ul class="list-disc pl-5 space-y-1 text-sm">
                            ${recommendations.map(r => `<li>${r}</li>`).join('')}
                            <li>Continuar monitoramento regular atrav√©s de avalia√ß√µes peri√≥dicas</li>
                            <li>Considerar encaminhamento para especialistas quando necess√°rio</li>
                        </ul>
                    </div>

                    <div class="text-xs text-gray-500 dark:text-gray-500 mt-4 p-3 border-t border-gray-300 dark:border-gray-700">
                        <p>Este relat√≥rio foi gerado automaticamente pelo Dashboard de Travas Mentais e deve ser interpretado por profissional qualificado.</p>
                        <p class="mt-1">Gerado em: ${new Date().toLocaleString('pt-BR')}</p>
                    </div>
                </div>
            `;

            showModal('Relat√≥rio Final - ' + patientName, reportHtml, [
                { label: 'Imprimir', onClick: 'printReport()', className: 'bg-purple-500 text-white hover:bg-purple-600' },
                { label: 'Fechar', onClick: 'closeModal()', className: 'bg-gray-200 dark:bg-gray-700' }
            ]);
        }

        function printReport() {
            window.print();
        }

        function printPatientData(patientName) {
            generateFinalReport(patientName);
            setTimeout(() => {
                window.print();
            }, 500);
        }

        // Main render function
        function render() {
            const app = document.getElementById('app');
            let content = '';

            switch (appState.currentPage) {
                case 'home':
                    content = renderHome();
                    break;
                case 'block':
                    content = renderBlock();
                    setTimeout(() => showTab('symptoms'), 0);
                    break;
                case 'patients':
                    content = renderPatients();
                    break;
                case 'patient-detail':
                    content = renderPatientDetail();
                    break;
                case 'analytics':
                    content = renderAnalytics();
                    break;
                default:
                    content = renderHome();
            }

            app.innerHTML = content;
        }

        // Initialize app
        initDB().then(() => {
            loadData();
        }).catch(error => {
            console.log('Error initializing database:', JSON.stringify({ message: error.message }));
            render();
        });
    </script>
</body>
</html>